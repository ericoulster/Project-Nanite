{% extends 'base.html' %}

{% block body_open_sidebar %} 
  {% include 'bodyopen-sidebar.html' %}
{% endblock %} 

{% block content %}
<div id="main-content" class="container">
  <!-- {% if not hasprojects %}
  <div class="greeting"><p class="username-greet">Hi, <span id="username">{{username}}</span>!</p>
    <p>Let's create your first project!</p>
  </div>
  {% endif %} -->

  <!-- Modal Triggers -->
  <button data-micromodal-trigger="modal-1" class="new-project">+ New Project</button>
  <button data-micromodal-trigger="modal-0" class="welcome-msg">?</button>
  <button data-micromodal-trigger="modal-stats" id="stats-toggle" style="display:none" aria-hidden="true"></button>
  <button data-micromodal-trigger="modal-edit-proj" id="edit-proj-toggle" style="display:none" aria-hidden="true"></button>
 
 
  <!-- Projects List -->
  <div id="projectslist" class="projectslist">
    <!-- Projects listed here by JS -->
  </div>

  <!-- Onboarding Modal -->
  {% with %}
  {% set modal_id = 'modal-0' %}    
  {% set modal_header_text = 'Welcome to Nanite' %}
  {% set modal_trigger_text = '?' %}
  {% set modal_trigger_classes = 'welcome-msg' %}
  {% set close_button_text = 'Continue' %}
  {% set close_btn_fn = "" %}
  {% set modal_contents_html = '<p>Nanite is designed to help you keep track of your writing habits and increase your productivity the more you use it.</p>
  <p>To get started, click the "New Project" button an link your text file to Nanite. Nanite will then traack your progress and give you useful insights.</p>'|safe %}
    {% include 'modal.html' %}
  {% endwith %}
  <!-- Onboarding Modal End -->
  <!-- New Project Modal -->
  {% with %}
    {% set modal_id = 'modal-1' %}
    {% set modal_header_text = 'Add A New Project' %}
    {% set modal_trigger_text = '+ New Project' %}
    {% set modal_trigger_classes = 'new-project' %}
    {% set close_button_text = 'Cancel' %}
    {% set close_btn_fn = "" %}
    {% set modal_contents_html = '<div id="new-project" class="new-project-form-container {% if hasprojects %}hidden{% endif %}">
      <form class="project-form new-project" onsubmit="add_new_project()">
        <fieldset> 
            <!-- <legend class="hidden">Add a new project here:</legend> -->
              <label>What\'s the name of your project?</label><input id="project-name" type="text" name="name" required>
              <label>File/folder Path:</label><input id="project-path" type="text" name="filepath" placeholder="C:/filepath/filename.txt" required>
              <button onclick="dir_select_tk_input()">Select Directory</button>
              <!-- <label>Files of type:</label> -->
              <!-- <select id="filetype" name="filetype" required>
                <option value="txt">txt</option>
                <option value="rtf">rtf</option>
                <option value="docx">docx</option>
              </select> -->
              <label>What\'s your writing goal?</label>
              <div class="writing-goal">
                <input id="wordcountgoal" type="text" name="wordcountgoal" required> words            
                <div class="radio-buttons">
                  <input type="radio" id="daily-new" name="wordcountreg" value="daily" required checked>
                  <label for="daily-new">Daily</label>
                  <input type="radio" id="total-new" name="wordcountreg" value="total" required>
                  <label for="total-new">Total</label>
                </div>
              </div>
              <div class="start-date-in"><label>Start Date:</label><input id="targetstartdate" type="date" name="targetstartdate" required></div>
              <div class="end-date-in"><label>Target End Date:</label><input id="targetenddate" type="date" name="targetenddate" required></div>
              <input type="submit" value="Add New Project">
        </fieldset> 
      </form>
    </div>'|safe %}
    {% include 'modal.html' %}
  {% endwith %}
  <!-- New Project Modal End -->
    <!-- Edit Project Modal -->
    {% with %}
    {% set modal_id = 'modal-edit-proj' %}
    {% set modal_header_text = 'Edit Existing Project' %}
    {% set modal_trigger_text = '+ New Project' %}
    {% set modal_trigger_classes = 'new-project' %}
    {% set close_button_text = 'Cancel' %}
    {% set close_btn_fn = "" %}
    {% set modal_contents_html = '<div id="new-project" class="new-project-form-container {% if hasprojects %}hidden{% endif %}">
      <form class="project-form new-project" onsubmit="editProjectDetails()">
        <fieldset> 
            <!-- <legend class="hidden">Add a new project here:</legend> -->
              <label>What\'s the name of your project?</label><input id="project-name" type="text" name="name" required>
              <label>File/folder Path:</label><input id="project-path" type="text" name="filepath" placeholder="C:/filepath/filename.txt" required>
              <button onclick="dir_select_tk_input()">Select Directory</button>
              <!-- <label>Files of type:</label> -->
              <!-- <select id="filetype" name="filetype" required>
                <option value="txt">txt</option>
                <option value="rtf">rtf</option>
                <option value="docx">docx</option>
              </select> -->
              <label>What\'s your writing goal?</label>
              <div class="writing-goal">
                <input id="wordcountgoal" type="text" name="wordcountgoal" required> words            
                <div class="radio-buttons">
                  <input type="radio" id="daily-new" name="wordcountreg" value="daily" required checked>
                  <label for="daily-new">Daily</label>
                  <input type="radio" id="total-new" name="wordcountreg" value="total" required>
                  <label for="total-new">Total</label>
                </div>
              </div>
              <!-- <div class="start-date-in"><label>Start Date:</label><input id="targetstartdate" type="date" name="targetstartdate" required></div> -->
              <div class="end-date-in"><label>Target End Date:</label><input id="targetenddate" type="date" name="targetenddate" required></div>
              <input type="submit" value="Add New Project">
        </fieldset> 
      </form>
    </div>'|safe %}
    {% include 'modal.html' %}
  {% endwith %}
  <!-- Edit Project Modal End -->
  <!-- Project Stats Modal -->
    {% with %}
    {% set modal_id = 'modal-stats' %}
    {% set modal_header_text = 'Project Stats' %}
    {% set modal_trigger_text = 'Project Stats' %}
    {% set modal_trigger_classes = 'viewStats' %}
    {% set close_button_text = 'Cancel' %}
    {% set close_btn_fn = 'onclick=reinitProgressBars()' %}
    {% set modal_contents_html = '<div>
      <!--Contents will be inserted via JS-->
    </div>'|safe %}
    {% include 'modal.html' %}
  {% endwith %}
  <!-- Project Stats Modal End -->
</div>
<script>
  // Initial
  var projectPage = document;
  var projectWindow = window;

  (async function () {
    let doc = await eel_list_projects_html_current_user();
    progress_bars(doc);
  }) ();


  // List all projects
  async function eel_list_projects_html_current_user() {
    let a = await eel_list_projects_html(get_username());
    return a;
  }

  async function eel_list_projects_html(username) {
    const parser = new DOMParser();
    let projectslist = document.querySelector('#projectslist');

    let htmlString = await eel.list_projects_html(username)();
    let doc = parser.parseFromString(htmlString, "text/html");

    // append to projects list div
    doc.querySelectorAll('body > *').forEach(x => {projectslist.appendChild(x);} )

    return doc;
  }

  // Rename Project

async function new_name_prompt(p_id) {
  let projectname =  document.querySelector('#project-' + String(p_id) + '-summary h2');
  let editbuttonimg =  document.querySelector('#project-' + String(p_id) + '-summary .edit-project.icon img');
  // Set title to be editable
  projectname.contentEditable = "true";
  projectname.focus();
  // Set edit button to be OK button
  editbuttonimg.src = '../static/imgs/icons/green-tick.svg';
  editbuttonimg.parentElement.onclick = function(){rename_project(p_id,projectname.textContent);}; // When tick is clicked, change name
}

// ==============================================/
//  EDIT PROJECT 
// ============================================/

const editProjectDetails = async(p_id) => {
  document.getElementById("edit-proj-toggle").click();
  let a = await eel_return_projects_by_name(get_username());
  console.log(a.filter(x => x[0] == p_id));
}

  //////////////////////////////////////
// DEBUGGER Function
  async function debug_p() {
    let projectslist = document.querySelector('#projectslist');
    let project = document.createElement('div');
    let a = await eel_return_projects_by_name(get_username());
    project.textContent = a;
    projectslist.appendChild(project);
  };

  async function eel_return_projects_by_name(username) {
    let a = await eel.return_projects_by_name(username)();
    return a;
  }
    //////////////////////////////////////

  function add_new_project() {
    authorname = get_username();
    projectname = document.querySelector("#project-name").value;
    targetstartdate = document.querySelector("#targetstartdate").value;
    targetenddate = document.querySelector("#targetenddate").value;
    wordcountgoal = document.querySelector("#wordcountgoal").value;

    /*------------------------------------------------------------!!!
     * TO DO: 
     *    - Double triple make sure wordcountgoal is an int
     *    - Allow user to hook onto individual files
     *------------------------------------------------------------!!!
     */

    // work out current_daily_target
    dailynew = document.querySelector("#daily-new").checked;
    totalnew = document.querySelector("#total-new").checked;

    if (dailynew) {
      current_daily_target = wordcountgoal;  
    } else {
      let daysBetwenDates = (Date.parse(targetenddate) - Date.parse(targetstartdate)) / (1000 * 3600 * 24)
      current_daily_target = `${Math.round(parseInt(wordcountgoal) / daysBetwenDates)}`;
    }
    wp_page = 42; // TO DO: Used for later if someone wants to count pages rather than words
    projectpath = document.querySelector("#project-path").value;
    //filetype = document.querySelector("#filetype").value;
    eel.new_project(authorname, projectname, targetstartdate , targetenddate, wordcountgoal, current_daily_target, wp_page, projectpath);
  };
  </script>
  <script>

      // Progress bar functions
    function progress_bars(doc) {
      waiting = doc; // this function should only run once doc has been awaited (from the previous function)
      let projectslist_items = projectPage.querySelectorAll('#projectslist > .projects-item');
      projectslist_items.forEach(x => {
        pb = x.querySelector('div[class^="progress-"]');
        p_id = pb.dataset.pid;
        daily_words = pb.dataset.todaywords; // currently Showing up as 0 despite all? <- due to lack of cascade drop
        today_goal = pb.dataset.todaygoal; 
        
        progress_bar(p_id, daily_words, today_goal); // previously 300  

        // Removes progress bars and creates new ones upon window resize
        reinitProgressBars();
      })
    }

    function progress_bar(p_id, daily_words, today_goal) { // previously , svgwidth
      var svgwidth = parseInt(window.getComputedStyle(document.querySelector(`div.project-summary.panels`)).width.slice(0, -2)) * .65;

      var data = {
            'Wtarget_sum': today_goal, 
            'daily_words': daily_words
      };
        
      // Sets progress_val to 0 if data.Wtarget_sum is 0 to avoid division by 0
        var progress_val = data.Wtarget_sum == 0 ? 0 : (data.daily_words / data.Wtarget_sum) * 100;

        if (progress_val < 25) {
            progress_color = "#D0D0D0"
        }
        else if (progress_val < 50) {
            progress_color = "#F6B85C"
        }
        else if (progress_val < 75) {
            progress_color = "#F6D55C"
        }
        else if (progress_val < 100) {
            progress_color = "#CEF65C"
        }
        else if (progress_val < 115) {
            progress_color = "#96F65C"
        }
        else if (progress_val < 200) {
            progress_color = "#5CF6D1"
        }
        else {
            progress_color = "#5CBFF6"
        };

        if (progress_val > 100) {
            progress_val_capped = 100
        }
        else {progress_val_capped = progress_val};

        
        var svg = d3.select(`.progress-${String(p_id)}`)
            .append('svg')
            .attr('height', 100)
            .attr('width', svgwidth * 2); // svgwidth previously set to 800

        var bar_width = svgwidth * 0.9; // previously 600 (or 0.75 * svg width)
        var bar_height = 20;


        var bar_x = (bar_width/50);
        var bar_y = (bar_height/3);

        var bar_cap = (bar_width/100);

        if (progress_val < 50) {
            var text_color ='#E3E3E3'
        }
        else {
            var text_color = '#1F2428'}

        svg.append('rect')
            .attr('class', 'bg-rect')
            .attr('rx', 20)
            .attr('ry', 20)
            .attr('fill', 'none')
            .attr('stroke', '#333A40')
            .attr('stroke-width', 4)
            .attr('height', bar_height + (bar_height*1))
            .attr('width', function(){
                return bar_width + (bar_width*0.07);
            })
            .attr('x', bar_x)
            .attr('y', bar_y);
        
        var progress = svg.append('rect')
                        .attr('class', 'progress-rect')
                        .attr('fill', progress_color)
                        .attr('height', bar_height)
                        .attr('width', 0)
                        .attr('rx', 10)
                        .attr('ry', 10)
                        .attr('x', bar_x + (bar_x*1.5)) // .2
                        .attr('y', bar_y + (bar_y*1.5));
    
        progress.transition()
            .duration(1000)
            .attr('width', function(){
                var index = progress_val_capped;
                return index * bar_cap;
            });



        let wordPerc = isNaN(Math.floor(progress_val)) ? 0 : Math.floor(progress_val);
        svg.append("text")
            .text(`${data['daily_words']}/${data['Wtarget_sum']} words (${wordPerc}%)`)
            .attr('x', bar_width/2 -50)
            .attr('y', bar_height*1.5)
            .attr('fill', '#333A40')
            .attr('font-family', 'Archivo')
            .attr('font-weight', 100)
            .attr('font-size', 'small')
            .style('fill', text_color)
            .raise()
    }

    const showStatsModal = async (selectedId) => {
      let selectedName =  document.querySelector('#project-' + String(selectedId) + '-summary h2').innerHTML;
      let statsData = await eel.eel_return_project_stats(selectedId)();

      // NEED TO FIND A BETTER WAY OF DOING THIS BUT FOR NOW HERE WE GO
      document.getElementById("stats-toggle").click();
      document.getElementById("modal-stats-title").innerHTML = `${selectedName} Statistics`
      statsModal_Populate(statsData);
    }

    // Used to delete and load progress bars upon resize
    const reinitProgressBars = () =>{
      d3.select(projectWindow).on("resize", () => {
          projectPage.querySelectorAll(".progress svg").forEach( elem => elem.parentNode.removeChild(elem))
          progress_bars("reloading")
        });  
    }
  </script>
  <script src="../static/js/stats-modal.js"></script>
{% endblock %}